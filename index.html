<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Многочаты с локальным хранением</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0e0f14;
      --card: #14181f;
      --text: #e6e6e6;
      --muted: #a6a6a6;
      --accent: #4e9cff;
      --shadow: 0 6px 20px rgba(0,0,0,.25);
      --input: #1e232a;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; background: var(--bg); color: var(--text); font-family: Inter, ui-sans-serif, system-ui, -apple-system; }
    .app { display: grid; grid-template-columns: 320px 1fr; gap: 16px; height: 100%; padding: 16px; }
    .panel { background: var(--card); border-radius: 12px; padding: 16px; box-shadow: var(--shadow); display: flex; flex-direction: column; }
    h1 { font-size: 18px; margin: 0 0 8px; }
    input, textarea, select {
      width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #2a2f38; background: #0f141b; color: var(--text);
    }
    textarea { resize: vertical; min-height: 64px; }
    .btn { padding: 10px 12px; border-radius: 8px; border: none; background: var(--accent); color: #fff; cursor: pointer; font-weight: 600; }
    .btn.secondary { background: #2c2f38; color: #e6e6e6; }
    .btn:disabled { opacity: .5; cursor: not-allowed; }
    .list { display: grid; gap: 8px; max-height: 60vh; overflow: auto; padding-right: 6px; }
    .room-item { padding: 10px; border-radius: 8px; background: #1a2030; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
    .room-item.active { outline: 2px solid var(--accent); }
    .chat { display: flex; flex-direction: column; height: 100%; }
    .messages { flex: 1; overflow: auto; padding: 12px; border-radius: 8px; background: #111827; border: 1px solid #232a34; }
    .message { margin: 6px 0; padding: 8px 10px; border-radius: 8px; max-width: 70%; }
    .me { background: #4e9cff; color: white; align-self: flex-end; }
    .them { background: #2a2f38; color: #eaeaea; align-self: flex-start; }
    .row { display: flex; gap: 8px; align-items: center; }
    .section { margin-bottom: 12px; }
    /* Темный режим toggle */
    .toggle { display: inline-flex; align-items: center; gap: 8px; user-select: none; }
    .badge { font-size: 12px; padding: 2px 6px; border-radius: 999px; background: #1e2430; color: #cbd5e1; }
    @media (max-width: 900px) {
      .app { grid-template-columns: 1fr; height: auto; }
      .panel { min-height: 240px; }
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- Левая панель: управление комнатами и профилем -->
    <aside class="panel" id="sidebar">
      <h1>Многочаты (локально)</h1>
      <div class="section">
        <div class="row" style="justify-content: space-between;">
          <strong>ВашUID</strong>
          <span class="badge" id="localUserUid">генерируется</span>
        </div>
      </div>

      <div class="section">
        <label for="newRoomName">Название комнаты (опционально)</label>
        <input id="newRoomName" placeholder="Например: Витамин - переговоры" />
        <button class="btn" id="createRoomBtn" style="margin-top:8px;">Создать комнату</button>
      </div>

      <div class="section" style="flex:1;">
        <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
          <strong>Доступные комнаты</strong>
          <span class="badge" id="roomCount">0</span>
        </div>
        <div class="list" id="roomsList"></div>
      </div>

      <div class="section">
        <label for="inviteCode">Код приглашения для текущей комнаты</label>
        <div class="row" style="gap:6px;">
          <input id="inviteCode" readonly placeholder="код комнаты будет здесь" />
          <button class="btn secondary" id="copyCodeBtn">Копировать</button>
        </div>
      </div>

      <div class="section" style="margin-top:auto;">
        <button class="btn secondary" id="toggleThemeBtn" title="Переключить тему">Темный режим</button>
      </div>
    </aside>

    <!-- Правая панель: чат выбранной комнаты -->
    <section class="panel chat" id="chatPanel">
      <div class="section" style="display:flex; justify-content: space-between; align-items: center;">
        <div style="display:flex; align-items: center; gap: 8px;">
          <strong id="currentRoomTitle">Выберите комнату</strong>
          <span class="badge" id="currentRoomCode" title="Код комнаты"></span>
        </div>
        <div class="row" style="gap:6px;">
          <input id="messageInput" placeholder="Напишите сообщение..." style="flex:1;" />
          <button class="btn" id="sendBtn">Отправить</button>
        </div>
      </div>

      <div class="messages" id="messages"></div>

      <div class="section" style="display:flex; gap:8px;">
        <textarea id="messagePreview" placeholder="Прокомментируйте..." style="flex:1; height:60px;"></textarea>
        <button class="btn" id="addSampleBtn">Добавить пример</button>
      </div>
    </section>
  </div>

  <script>
    // Простые утилиты
    function uid(len = 8) {
      // простая генерация уникального кода
      const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
      let s = '';
      for (let i = 0; i < len; i++) s += chars.charAt(Math.floor(Math.random() * chars.length));
      return s;
    }

    function save(key, value) {
      localStorage.setItem(key, JSON.stringify(value));
    }
    function load(key, fallback) {
      try {
        const v = localStorage.getItem(key);
        return v ? JSON.parse(v) : fallback;
      } catch {
        return fallback;
      }
    }

    // Префикс для локального хранилища под этот экземпляр
    const STORAGE_PREFIX = 'local.chat.app';

    // Глобальные переменные
    let currentUser = null;
    let rooms = {}; // код -> { name, messages: [{from, text, ts}] }
    let activeRoomCode = null;
    let dark = true; // начальная тема — темная

    // Инициализация пользователя
    function initUser() {
      const existing = load(STORAGE_PREFIX + '.user', null);
      if (existing && existing.uid) {
        currentUser = existing;
      } else {
        currentUser = { uid: 'U' + uid(6), name: 'Пользователь ' + uid(4) };
        save(STORAGE_PREFIX + '.user', currentUser);
      }
      document.getElementById('localUserUid').textContent = currentUser.uid;
    }

    // Загрузка комнат
    function loadRooms() {
      const r = load(STORAGE_PREFIX + '.rooms', {});
      rooms = r;
      // восстановим активную комнату если была
      activeRoomCode = load(STORAGE_PREFIX + '.activeRoom', null);
    }

    function persistRooms() {
      save(STORAGE_PREFIX + '.rooms', rooms);
      save(STORAGE_PREFIX + '.activeRoom', activeRoomCode);
    }

    // UI обновления
    function renderRooms() {
      const list = document.getElementById('roomsList');
      list.innerHTML = '';
      const codes = Object.keys(rooms);
      codes.forEach(code => {
        const item = document.createElement('div');
        item.className = 'room-item' + (code === activeRoomCode ? ' active' : '');
        item.style.cursor = 'pointer';
        item.innerHTML = `
          <span style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width: 180px;">
            ${rooms[code].name || 'Комната ' + code}
          </span>
          <span class="badge" title="Код комнаты">${code}</span>
        `;
        item.addEventListener('click', () => switchRoom(code));
        list.appendChild(item);
      });
      document.getElementById('roomCount').textContent = codes.length;
    }

    function renderMessages() {
      const el = document.getElementById('messages');
      el.innerHTML = '';
      if (!activeRoomCode || !rooms[activeRoomCode]) return;
      const msgs = rooms[activeRoomCode].messages || [];
      msgs.forEach(m => {
        const div = document.createElement('div');
        div.className = 'message ' + (m.from === currentUser.uid ? 'me' : 'them');
        div.textContent = `[${new Date(m.ts).toLocaleTimeString()}] ${m.from === currentUser.uid ? 'Вы' : m.from}: ${m.text}`;
        el.appendChild(div);
      });
      el.scrollTop = el.scrollHeight;
    }

    function switchRoom(code) {
      activeRoomCode = code;
      save(STORAGE_PREFIX + '.activeRoom', activeRoomCode);
      // визуальные обновления
      document.getElementById('currentRoomTitle').textContent = rooms[code].name || 'Без названия';
      document.getElementById('currentRoomCode').textContent = code;
      renderRooms();
      renderMessages();
      // копируем код в инпут приглашения
      document.getElementById('inviteCode').value = code;
    }

    // Создать новую комнату
    function createRoom() {
      const nameInput = document.getElementById('newRoomName').value.trim();
      const code = uid(6);
      rooms[code] = {
        code,
        name: nameInput || ('Комната ' + code),
        messages: []
      };
      persistRooms();
      renderRooms();
      switchRoom(code);
      // генерируем приглашение сразу
      document.getElementById('inviteCode').value = code;
    }

    // Отправка сообщения
    function sendMessage() {
      if (!activeRoomCode || !rooms[activeRoomCode]) return;
      const text = document.getElementById('messageInput').value.trim();
      if (!text) return;
      rooms[activeRoomCode].messages = rooms[activeRoomCode].messages || [];
      rooms[activeRoomCode].messages.push({
        from: currentUser.uid,
        text,
        ts: Date.now()
      });
      document.getElementById('messageInput').value = '';
      persistRooms();
      renderMessages();
    }

    // Примеры
    function addSample() {
      if (!activeRoomCode || !rooms[activeRoomCode]) return;
      const samples = [
        'Привет! Как дела?',
        'Какие планы на сегодня?',
        'Давай обсудим проект.',
        'Мне нужен файл по задаче.'
      ];
      const pick = samples[Math.floor(Math.random() * samples.length)];
      rooms[activeRoomCode].messages = rooms[activeRoomCode].messages || [];
      rooms[activeRoomCode].messages.push({
        from: 'system',
        text: pick,
        ts: Date.now()
      });
      persistRooms();
      renderMessages();
    }

    // Темный режим переключение
    function toggleTheme() {
      // простая реализация: инвертируем переменные CSS
      dark = !dark;
      // минимальная смена темы на лету
      if (dark) {
        document.documentElement.style.setProperty('--bg', '#0e0f14');
        document.documentElement.style.setProperty('--card', '#14181f');
        document.documentElement.style.setProperty('--text', '#e6e6e6');
        document.documentElement.style.setProperty('--input', '#1e232a');
      } else {
        // светлая тема
        document.documentElement.style.setProperty('--bg', '#f6f7fb');
        document.documentElement.style.setProperty('--card', '#ffffff');
        document.documentElement.style.setProperty('--text', '#111827');
        document.documentElement.style.setProperty('--input', '#f0f0f4');
      }
    }

    // Привязка кнопок
    document.getElementById('createRoomBtn').addEventListener('click', createRoom);
    document.getElementById('sendBtn').addEventListener('click', sendMessage);
    document.getElementById('copyCodeBtn').addEventListener('click', () => {
      const code = document.getElementById('inviteCode').value;
      if (!code) return;
      navigator.clipboard.writeText(code).then(() => {
        alert('Код скопирован: ' + code);
      });
    });
    document.getElementById('addSampleBtn').addEventListener('click', addSample);
    document.getElementById('toggleThemeBtn').addEventListener('click', () => {
      toggleTheme();
      document.getElementById('toggleThemeBtn').textContent = dark ? 'Темный режим' : 'Светлая тема';
    });

    // Обработка Enter для отправки
    document.getElementById('messageInput').addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    // Инициализация
    (function init() {
      initUser();
      loadRooms();
      // если есть активная комната в хранилище, откройте ее
      if (activeRoomCode && rooms[activeRoomCode]) {
        switchRoom(activeRoomCode);
      } else {
        // создаем одну пустую комнату по умолчанию если нет
        const defCode = uid(6);
        rooms[defCode] = { code: defCode, name: 'Локальная беседа', messages: [] };
        activeRoomCode = defCode;
        save(STORAGE_PREFIX + '.activeRoom', activeRoomCode);
        persistRooms();
        renderRooms();
        switchRoom(defCode);
      }
      renderRooms();
      renderMessages();
      //初始 кнопка
      document.getElementById('inviteCode').value = activeRoomCode || '';
      document.getElementById('currentRoomCode').textContent = activeRoomCode || '';
      // тема
      document.getElementById('toggleThemeBtn').textContent = dark ? 'Темный режим' : 'Светлая тема';
      // применяем стартовую тему
      toggleTheme(); // применим базовую
      // затем вернуть текущую тему в оригинальное состояние (только если нужно)
    })();
  </script>
</body>
</html>
