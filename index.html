<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2P Internet Chat</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root {
            --bg-color: #ffffff;
            --chat-bg: #f0f2f5;
            --sidebar-bg: #ffffff;
            --text-color: #050505;
            --primary-color: #0084ff;
            --received-msg-bg: #e4e6eb;
            --sent-msg-text: #ffffff;
            --border-color: #ddd;
        }

        [data-theme="dark"] {
            --bg-color: #18191a;
            --chat-bg: #242526;
            --sidebar-bg: #242526;
            --text-color: #e4e6eb;
            --primary-color: #2d88ff;
            --received-msg-bg: #3a3b3c;
            --sent-msg-text: #ffffff;
            --border-color: #3e4042;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background-color: var(--bg-color); color: var(--text-color); height: 100vh; display: flex; overflow: hidden; }

        /* –≠–ö–†–ê–ù –í–•–û–î–ê */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color); z-index: 100;
            display: flex; align-items: center; justify-content: center;
        }
        .card {
            background: var(--sidebar-bg); padding: 2rem; border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1); width: 90%; max-width: 400px;
            text-align: center; border: 1px solid var(--border-color);
        }
        input {
            width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px;
            border: 1px solid var(--border-color); background: var(--chat-bg);
            color: var(--text-color); outline: none;
        }
        button {
            width: 100%; padding: 12px; border: none; border-radius: 8px;
            background: var(--primary-color); color: white; font-weight: bold;
            cursor: pointer; margin-top: 5px; font-size: 1rem;
        }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .status { margin-top: 10px; font-size: 0.9rem; color: #888; min-height: 20px;}

        /* –ß–ê–¢ */
        #chat-app { display: none; width: 100%; height: 100%; flex-direction: column; }
        header {
            padding: 15px; background: var(--sidebar-bg); border-bottom: 1px solid var(--border-color);
            display: flex; justify-content: space-between; align-items: center;
        }
        #messages-area {
            flex: 1; overflow-y: auto; padding: 20px; background: var(--chat-bg);
            display: flex; flex-direction: column; gap: 10px;
        }
        .message {
            max-width: 75%; padding: 10px 15px; border-radius: 18px; font-size: 0.95rem;
            line-height: 1.4; word-wrap: break-word;
        }
        .sent { align-self: flex-end; background: var(--primary-color); color: var(--sent-msg-text); border-bottom-right-radius: 2px; }
        .received { align-self: flex-start; background: var(--received-msg-bg); color: var(--text-color); border-bottom-left-radius: 2px; }
        
        footer { padding: 15px; background: var(--sidebar-bg); display: flex; gap: 10px; border-top: 1px solid var(--border-color); }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid var(--primary-color); border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; margin-right: 5px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="card" id="step-1">
            <h2>–ò–Ω—Ç–µ—Ä–Ω–µ—Ç –ß–∞—Ç</h2>
            <p style="opacity: 0.7; font-size: 0.9rem; margin-bottom: 15px;">P2P —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ (—Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç)</p>
            <input type="text" id="my-name" placeholder="–í–∞—à–µ –∏–º—è" maxlength="15">
            <button onclick="initPeer()">–ü–æ–ª—É—á–∏—Ç—å –º–æ–π ID</button>
        </div>

        <div class="card" id="step-2" style="display: none;">
            <h3>–í–∞—à ID:</h3>
            <div style="background: var(--chat-bg); padding: 10px; border-radius: 5px; margin: 10px 0; font-family: monospace; font-weight: bold; border: 1px solid var(--primary-color); color: var(--primary-color); word-break: break-all;" id="my-id-display">...</div>
            <p style="font-size: 0.8rem; margin-bottom: 15px;">–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —ç—Ç–æ—Ç ID –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –¥—Ä—É–≥—É,<br>–∏–ª–∏ –≤—Å—Ç–∞–≤—å—Ç–µ ID –¥—Ä—É–≥–∞ –Ω–∏–∂–µ.</p>
            
            <div style="border-top: 1px solid var(--border-color); margin: 15px 0;"></div>
            
            <input type="text" id="friend-id" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ ID –¥—Ä—É–≥–∞ —Å—é–¥–∞">
            <button onclick="connectToFriend()">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
            <div class="status" id="status-msg">–û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...</div>
        </div>
    </div>

    <div id="chat-app">
        <header>
            <div>
                <span style="font-weight: bold;">–ß–∞—Ç —Å —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–æ–º</span><br>
                <span style="font-size: 0.8rem; opacity: 0.7;" id="chat-status">–ü–æ–¥–∫–ª—é—á–µ–Ω–æ</span>
            </div>
            <button onclick="toggleTheme()" style="width: auto; padding: 5px 15px; background: transparent; color: var(--text-color); border: 1px solid var(--border-color);">üåì</button>
        </header>

        <div id="messages-area"></div>

        <footer>
            <input type="text" id="msg-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." onkeypress="handleEnter(event)">
            <button onclick="sendMessage()" style="width: auto; padding: 0 20px;">‚û§</button>
        </footer>
    </div>

    <script>
        let peer;
        let conn;
        let myName = '';

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–µ–º—ã
        if (localStorage.getItem('theme') === 'dark') document.body.setAttribute('data-theme', 'dark');
        function toggleTheme() {
            const body = document.body;
            const newTheme = body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            body.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        }

        // –®–ê–ì 1: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        function initPeer() {
            myName = document.getElementById('my-name').value.trim();
            if (!myName) return alert("–í–≤–µ–¥–∏—Ç–µ –∏–º—è!");

            document.getElementById('step-1').style.display = 'none';
            document.getElementById('step-2').style.display = 'block';
            document.getElementById('status-msg').innerHTML = '<div class="loader"></div> –ì–µ–Ω–µ—Ä–∞—Ü–∏—è ID...';

            // –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç Peer (–∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—É–±–ª–∏—á–Ω—ã–π —Å–µ—Ä–≤–µ—Ä peerjs)
            peer = new Peer(null, {
                debug: 2
            });

            peer.on('open', (id) => {
                document.getElementById('my-id-display').textContent = id;
                document.getElementById('status-msg').textContent = '–û—Ç–ø—Ä–∞–≤—å—Ç–µ –≤–∞—à ID –¥—Ä—É–≥—É –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –µ–≥–æ ID.';
                
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ
                document.getElementById('my-id-display').onclick = () => {
                    navigator.clipboard.writeText(id);
                    alert("ID —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!");
                };
            });

            // –ï—Å–ª–∏ –∫—Ç–æ-—Ç–æ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ –Ω–∞–º
            peer.on('connection', (c) => {
                conn = c;
                setupConnection();
            });
            
            peer.on('error', (err) => {
                alert("–û—à–∏–±–∫–∞: " + err.type);
            });
        }

        // –®–ê–ì 2: –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –¥—Ä—É–≥—É
        function connectToFriend() {
            const friendId = document.getElementById('friend-id').value.trim();
            if (!friendId) return alert("–í–≤–µ–¥–∏—Ç–µ ID –¥—Ä—É–≥–∞!");
            
            document.getElementById('status-msg').innerHTML = '<div class="loader"></div> –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...';
            
            conn = peer.connect(friendId);
            setupConnection();
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è (–æ–±—â–∞—è –ª–æ–≥–∏–∫–∞)
        function setupConnection() {
            conn.on('open', () => {
                // –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('chat-app').style.display = 'flex';
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞—à–µ –∏–º—è —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
                conn.send({ type: 'system', text: myName + ' –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è –∫ —á–∞—Ç—É' });
            });

            conn.on('data', (data) => {
                renderMessage(data, false);
            });

            conn.on('close', () => {
                alert("–°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –ø–æ–∫–∏–Ω—É–ª —á–∞—Ç");
                location.reload();
            });
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
        function sendMessage() {
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            if (!text || !conn) return;

            const msgData = { type: 'message', user: myName, text: text };
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —É —Å–µ–±—è
            renderMessage(msgData, true);
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥—Ä—É–≥—É
            conn.send(msgData);
            
            input.value = '';
        }

        function renderMessage(data, isMine) {
            const area = document.getElementById('messages-area');
            const div = document.createElement('div');
            
            if (data.type === 'system') {
                div.style.textAlign = 'center';
                div.style.fontSize = '0.8rem';
                div.style.opacity = '0.6';
                div.style.margin = '10px 0';
                div.innerText = data.text;
            } else {
                div.className = `message ${isMine ? 'sent' : 'received'}`;
                div.innerHTML = `
                    <div style="font-size:0.7rem; margin-bottom:2px; opacity:0.8">${isMine ? '–í—ã' : escapeHtml(data.user)}</div>
                    ${escapeHtml(data.text)}
                `;
            }
            
            area.appendChild(div);
            area.scrollTop = area.scrollHeight;
        }

        function handleEnter(e) {
            if (e.key === 'Enter') sendMessage();
        }

        function escapeHtml(text) {
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        }
    </script>
</body>
</html>
