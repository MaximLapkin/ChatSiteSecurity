<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=yes">
    <title>roomchat ¬∑ –º—É–ª—å—Ç–∏—á–∞—Ç —Å –∫–æ–º–Ω–∞—Ç–∞–º–∏</title>
    <!-- Inter font & simple reset -->
    <style>
        /* GLOBAL ‚Äî Inter, box-sizing, clean */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            transition: background 0.2s ease, border-color 0.15s, box-shadow 0.2s;
        }

        body {
            background: #f7f9fc; /* light base */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            margin: 0;
        }

        /* themes ‚Äî light / dark via body classes */
        body.light-theme {
            background: #f4f6fa;
        }
        body.dark-theme {
            background: #0b0e14;
        }

        /* main card ‚Äî glassmorphism / soft shadows */
        .app-wrapper {
            max-width: 1150px;
            width: 100%;
            background: rgba(255,255,255,0.7);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-radius: 36px;
            box-shadow: 0 15px 35px -10px rgba(0,0,0,0.08), 0 2px 6px rgba(0,0,0,0.02);
            padding: 30px 32px;
            border: 1px solid rgba(255,255,255,0.3);
        }
        body.dark-theme .app-wrapper {
            background: rgba(18, 22, 30, 0.8);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255,255,255,0.06);
            box-shadow: 0 20px 40px -12px rgba(0,0,0,0.5);
        }

        /* theme toggle pill */
        .theme-toggle {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 20px;
        }
        .theme-btn {
            background: white;
            border: none;
            padding: 10px 22px;
            border-radius: 100px;
            font-size: 0.9rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: #1e293b;
            box-shadow: 0 4px 12px rgba(0,0,0,0.02);
            border: 1px solid rgba(0,0,0,0.02);
            cursor: pointer;
            transition: 0.15s;
        }
        body.dark-theme .theme-btn {
            background: #1e2632;
            color: #edf2f7;
            border-color: #334155;
            box-shadow: none;
        }
        .theme-btn:hover { background: #f1f5f9; }
        body.dark-theme .theme-btn:hover { background: #2d3748; }

        /* –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω ‚Äî —Å–ø–∏—Å–æ–∫ –∫–æ–º–Ω–∞—Ç + —à–∞–ø–∫–∞ */
        .screen-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 28px;
            flex-wrap: wrap;
        }
        h1, h2 {
            font-weight: 600;
            letter-spacing: -0.02em;
        }
        h1 { font-size: 1.9rem; color: #0f172a; }
        body.dark-theme h1 { color: #f1f5f9; }
        h2 { font-size: 1.4rem; margin-bottom: 16px; color: #1e293b; }
        body.dark-theme h2 { color: #e2e8f0; }

        .btn {
            background: #3b82f6;
            border: none;
            color: white;
            font-weight: 600;
            padding: 12px 28px;
            border-radius: 40px;
            font-size: 1rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 8px 16px -6px rgba(59,130,246,0.25);
            transition: all 0.15s;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .btn:hover { background: #2563eb; transform: scale(0.98); box-shadow: 0 6px 12px -4px #3b82f680; }
        .btn-outline {
            background: transparent;
            border: 1px solid #3b82f6;
            color: #3b82f6;
            box-shadow: none;
        }
        body.dark-theme .btn-outline {
            color: #a5d8ff;
            border-color: #3b82f6;
            background: rgba(59,130,246,0.08);
        }
        .btn-outline:hover { background: rgba(59,130,246,0.1); }

        /* –∫–æ–º–Ω–∞—Ç—ã —Å–µ—Ç–∫–∞ */
        .rooms-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(270px, 1fr));
            gap: 22px;
            margin-top: 12px;
            margin-bottom: 30px;
        }
        .room-card {
            background: white;
            border-radius: 28px;
            padding: 22px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.02);
            border: 1px solid rgba(0,0,0,0.02);
            backdrop-filter: blur(4px);
            transition: all 0.2s;
        }
        body.dark-theme .room-card {
            background: #1e2632;
            border-color: #2d3748;
            box-shadow: 0 12px 18px -8px #00000030;
        }
        .room-code-badge {
            font-size: 1.3rem;
            font-weight: 700;
            background: #eff6ff;
            display: inline-block;
            padding: 6px 16px;
            border-radius: 40px;
            letter-spacing: 0.5px;
            color: #1e4f8a;
            margin-bottom: 14px;
        }
        body.dark-theme .room-code-badge {
            background: #2d3748;
            color: #b9d9ff;
        }
        .room-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 16px 0 8px;
            color: #475569;
        }
        body.dark-theme .room-meta { color: #a0afc0; }
        .delete-btn {
            background: none;
            border: none;
            color: #94a3b8;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 6px;
            border-radius: 30px;
        }
        .delete-btn:hover { background: #f1f5f9; color: #ef4444; }
        body.dark-theme .delete-btn:hover { background: #2d3748; color: #f87171; }

        /* —ç–∫—Ä–∞–Ω –∫–æ–º–Ω–∞—Ç—ã / —á–∞—Ç */
        .room-screen {
            background: rgba(255,255,255,0.5);
            border-radius: 32px;
            padding: 28px;
            margin-top: 12px;
            backdrop-filter: blur(6px);
        }
        body.dark-theme .room-screen {
            background: rgba(25, 30, 40, 0.7);
        }

        .code-display-area {
            background: #f0f4fe;
            border-radius: 50px;
            padding: 18px 26px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
        }
        body.dark-theme .code-display-area {
            background: #0f131a;
        }
        .big-code {
            font-size: 2rem;
            font-weight: 700;
            letter-spacing: 2px;
            color: #1e293b;
        }
        body.dark-theme .big-code { color: #e0f2fe; }

        .input-field {
            padding: 14px 22px;
            border-radius: 50px;
            border: 1px solid #e2e8f0;
            background: white;
            font-size: 1rem;
            width: 100%;
            margin: 8px 0;
        }
        body.dark-theme .input-field {
            background: #1a202c;
            border-color: #3a4556;
            color: #f1f5f9;
        }

        /* —á–∞—Ç-—Å–æ–æ–±—â–µ–Ω–∏—è */
        .chat-messages {
            max-height: 360px;
            overflow-y: auto;
            padding: 12px 6px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-bottom: 20px;
        }
        .message {
            display: flex;
            align-items: flex-start;
            gap: 14px;
        }
        .avatar {
            width: 42px;
            height: 42px;
            background: #3b82f6;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            flex-shrink: 0;
            box-shadow: 0 6px 12px #3b82f650;
        }
        .message-content {
            background: white;
            padding: 14px 20px;
            border-radius: 22px;
            border-top-left-radius: 6px;
            max-width: 80%;
            box-shadow: 0 4px 8px rgba(0,0,0,0.02);
        }
        body.dark-theme .message-content {
            background: #2d3748;
            color: #f1f5f9;
        }
        .msg-author {
            font-weight: 700;
            color: #0f172a;
            margin-bottom: 6px;
        }
        body.dark-theme .msg-author { color: #e2e8f0; }
        .msg-time {
            font-size: 0.7rem;
            color: #64748b;
            margin-left: 10px;
        }
        .msg-text {
            line-height: 1.5;
            word-break: break-word;
        }

        /* —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏ –∏ –∫–Ω–æ–ø–∫–∏ –≤–Ω—É—Ç—Ä–∏ –∫–æ–º–Ω–∞—Ç—ã */
        .action-row {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            align-items: center;
        }
        .mt-4 { margin-top: 24px; }
        .w-full { width: 100%; }

        /* –∞–¥–∞–ø—Ç–∏–≤ */
        @media (max-width: 640px) {
            .app-wrapper { padding: 22px 18px; }
            .big-code { font-size: 1.6rem; }
        }

        /* —Å–∫—Ä—ã—Ç–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .badge-users {
            background: #dbeafe;
            padding: 6px 14px;
            border-radius: 50px;
            font-size: 0.85rem;
        }
        body.dark-theme .badge-users { background: #2e4a6a; color: #e6f0ff; }
    </style>
</head>
<body class="light-theme">
    <div class="app-wrapper" id="appRoot">
        <!-- –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ç–µ–º—ã -->
        <div class="theme-toggle">
            <button class="theme-btn" id="themeToggleBtn">
                <span id="themeIcon">üåô</span> –¢–µ–º–Ω–∞—è —Ç–µ–º–∞
            </button>
        </div>

        <!-- –∫–æ—Ä–Ω–µ–≤–æ–π view: –≥–ª–∞–≤–Ω–∞—è / –∫–æ–º–Ω–∞—Ç–∞ / –≥–æ—Å—Ç—å-–≤–≤–æ–¥ -->
        <div id="viewContainer"></div>
    </div>

    <script>
        (function(){
            'use strict';

            // ---------- –ì–õ–û–ë–ê–õ–¨–ù–û–ï –•–†–ê–ù–ò–õ–ò–©–ï, –°–û–°–¢–û–Ø–ù–ò–Ø ----------
            // –≤—Å–µ –∫–æ–º–Ω–∞—Ç—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ localStorage: –∫–ª—é—á "rooms_metadata" ‚Äî –º–∞—Å—Å–∏–≤ { code, hostName, users: [] } 
            // –æ—Ç–¥–µ–ª—å–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏—è: `chat_${roomCode}` ‚Äî –º–∞—Å—Å–∏–≤ { name, text, time, avatarColor? }
            // —Ç–∞–∫–∂–µ –¥–ª—è —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏: —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, —Ç–µ–∫—É—â–∞—è –∫–æ–º–Ω–∞—Ç–∞ –∏ —Ç.–¥.
            
            const STORAGE_ROOMS_KEY = 'roomchat_rooms';
            const APP_PREFIX = 'roomchat_';

            // —Ç–µ–º–∞
            let currentTheme = localStorage.getItem('theme') || 'light';
            // –≥–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
            let appState = {
                view: 'home',           // home, hostRoom, guestRoom, chatRoom
                currentRoomCode: null,
                currentUserName: null,
                currentUserIsHost: false,
            };

            // ---------- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –•–†–ê–ù–ò–õ–ò–©–ê ----------
            function loadRooms() {
                const data = localStorage.getItem(STORAGE_ROOMS_KEY);
                if (!data) return [];
                try { return JSON.parse(data); } catch { return []; }
            }

            function saveRooms(rooms) {
                localStorage.setItem(STORAGE_ROOMS_KEY, JSON.stringify(rooms));
                // –±—Ä–æ–∞–¥–∫–∞—Å—Ç —á–µ—Ä–µ–∑ storage event ‚Äî –Ω–æ –æ–Ω —Å–∞–º —Ç—Ä–∏–≥–≥–µ—Ä–∏—Ç –Ω–∞ –¥—Ä—É–≥–∏—Ö –≤–∫–ª–∞–¥–∫–∞—Ö
                // dispatchEvent –≤ —Ç–æ–π –∂–µ –≤–∫–ª–∞–¥–∫–µ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
                window.dispatchEvent(new Event('storage'));
            }

            // –ø–æ–ª—É—á–∏—Ç—å –º–∞—Å—Å–∏–≤ —Å–æ–æ–±—â–µ–Ω–∏–π –∫–æ–º–Ω–∞—Ç—ã
            function getMessages(roomCode) {
                const key = `chat_${roomCode}`;
                const raw = localStorage.getItem(key);
                return raw ? JSON.parse(raw) : [];
            }

            function saveMessages(roomCode, messages) {
                const key = `chat_${roomCode}`;
                localStorage.setItem(key, JSON.stringify(messages));
                window.dispatchEvent(new Event('storage')); // —Ç—Ä–∏–≥–≥–µ—Ä–∏–º —Å–æ–±—ã—Ç–∏–µ –¥–ª—è —ç—Ç–æ–π –∂–µ –≤–∫–ª–∞–¥–∫–∏
            }

            // –¥–æ–±–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
            function addMessage(roomCode, name, text) {
                const msgs = getMessages(roomCode);
                const time = new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
                msgs.push({ name, text, time, avatar: name.substring(0,2).toUpperCase() });
                saveMessages(roomCode, msgs);
            }

            // –ø–æ–ª—É—á–∏—Ç—å –∫–æ–ª-–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∫–æ–º–Ω–∞—Ç—ã (–ø–æ –¥–∞–Ω–Ω—ã–º –∏–∑ metadata)
            function getRoomUsersCount(roomCode) {
                const rooms = loadRooms();
                const room = rooms.find(r => r.code === roomCode);
                return room ? (room.users?.length || 0) : 0;
            }

            // –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∫–æ–º–Ω–∞—Ç—É
            function addUserToRoom(roomCode, userName) {
                const rooms = loadRooms();
                const room = rooms.find(r => r.code === roomCode);
                if (room && room.users.length < 2 && !room.users.includes(userName)) {
                    room.users.push(userName);
                    saveRooms(rooms);
                    return true;
                }
                return false;
            }

            // —É–¥–∞–ª–∏—Ç—å –∫–æ–º–Ω–∞—Ç—É
            function deleteRoom(roomCode) {
                let rooms = loadRooms();
                rooms = rooms.filter(r => r.code !== roomCode);
                saveRooms(rooms);
                localStorage.removeItem(`chat_${roomCode}`);
                // –µ—Å–ª–∏ —Ç–µ–∫—É—â–∞—è –∫–æ–º–Ω–∞—Ç–∞ —É–¥–∞–ª–µ–Ω–∞ ‚Äî —É–π—Ç–∏ –Ω–∞ home
                if (appState.currentRoomCode === roomCode) {
                    appState = { view: 'home', currentRoomCode: null, currentUserName: null, currentUserIsHost: false };
                }
                render();
            }

            // –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–¥–∞
            function generateRoomCode() {
                const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ0123456789';
                let part1 = '', part2 = '';
                for (let i = 0; i < 3; i++) part1 += chars[Math.floor(Math.random() * chars.length)];
                for (let i = 0; i < 3; i++) part2 += chars[Math.floor(Math.random() * chars.length)];
                return `${part1}-${part2}`;
            }

            // ---------- –¢–ï–ú–ê ----------
            function applyTheme(theme) {
                const body = document.body;
                body.classList.remove('light-theme', 'dark-theme');
                body.classList.add(theme === 'dark' ? 'dark-theme' : 'light-theme');
                const btn = document.getElementById('themeToggleBtn');
                if (btn) {
                    const span = document.getElementById('themeIcon');
                    if (theme === 'dark') {
                        span.textContent = '‚òÄÔ∏è';
                        btn.innerHTML = '<span id="themeIcon">‚òÄÔ∏è</span> –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞';
                    } else {
                        span.textContent = 'üåô';
                        btn.innerHTML = '<span id="themeIcon">üåô</span> –¢–µ–º–Ω–∞—è —Ç–µ–º–∞';
                    }
                }
                localStorage.setItem('theme', theme);
                currentTheme = theme;
            }

            // –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–µ–º—ã
            function toggleTheme() {
                const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                applyTheme(newTheme);
            }

            // ---------- –û–°–ù–û–í–ù–û–ô –†–ï–ù–î–ï–† ----------
            const container = document.getElementById('viewContainer');

            function render() {
                if (!container) return;
                const view = appState.view;
                if (view === 'home') container.innerHTML = renderHome();
                else if (view === 'hostRoom') container.innerHTML = renderHostRoom();
                else if (view === 'guestJoin') container.innerHTML = renderGuestJoin();
                else if (view === 'chatRoom') container.innerHTML = renderChatRoom();
                attachListeners();
            }

            // ---- –ì–õ–ê–í–ù–ê–Ø (–°–ü–ò–°–û–ö –ö–û–ú–ù–ê–¢) ----
            function renderHome() {
                const rooms = loadRooms();
                return `
                    <div>
                        <div class="screen-header">
                            <h1>üì¶ roomchat</h1>
                            <button class="btn" id="createRoomBtn">+ –ù–æ–≤–∞—è –∫–æ–º–Ω–∞—Ç–∞</button>
                        </div>
                        <h2>–í–∞—à–∏ –∫–æ–º–Ω–∞—Ç—ã</h2>
                        ${rooms.length === 0 ? '<p style="color: #64748b; margin-top: 30px; text-align: center;">‚Äî –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–º–Ω–∞—Ç. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é ‚Äî</p>' : ''}
                        <div class="rooms-grid">
                            ${rooms.map(room => {
                                const usersCount = room.users?.length || 0;
                                const isFull = usersCount >= 2;
                                return `
                                <div class="room-card" data-code="${room.code}">
                                    <span class="room-code-badge">${room.code}</span>
                                    <div class="room-meta">
                                        <span>üë• ${usersCount}/2</span>
                                        <span>üé© —Ö–æ—Å—Ç: ${room.hostName || '‚Äî'}</span>
                                    </div>
                                    <div style="display: flex; gap: 10px; justify-content: space-between; align-items:center;">
                                        ${!isFull ? `<button class="btn btn-outline" style="padding: 8px 18px;" data-action="joinAsGuest" data-code="${room.code}">‚ûï –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>` : 
                                            `<span class="badge-users">‚ùå –ø–æ–ª–Ω–∞—è</span>`}
                                        <button class="delete-btn" data-action="deleteRoom" data-code="${room.code}" title="–£–¥–∞–ª–∏—Ç—å –∫–æ–º–Ω–∞—Ç—É">üóëÔ∏è</button>
                                    </div>
                                </div>`;
                            }).join('')}
                        </div>
                    </div>
                `;
            }

            // ---- –•–û–°–¢ –†–ï–ñ–ò–ú (–ø–æ–∫–∞–∑ –∫–æ–¥–∞, –æ–∂–∏–¥–∞–Ω–∏–µ) ----
            function renderHostRoom() {
                const code = appState.currentRoomCode;
                const rooms = loadRooms();
                const room = rooms.find(r => r.code === code);
                if (!room) { appState.view = 'home'; return renderHome(); }
                const usersCount = room.users?.length || 0;
                return `
                    <div>
                        <button class="btn-outline" style="padding: 10px 22px; margin-bottom: 24px;" id="backToHomeBtn">‚Üê –í—Å–µ –∫–æ–º–Ω–∞—Ç—ã</button>
                        <div class="room-screen">
                            <h2 style="margin-bottom: 8px;">üëë –ö–æ–º–Ω–∞—Ç–∞ —Ö–æ—Å—Ç–∞</h2>
                            <div class="code-display-area">
                                <span class="big-code">${code}</span>
                                <button class="btn-outline" id="copyCodeBtn" style="padding: 12px 22px;">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                            </div>
                            <p style="margin: 24px 0 12px; font-size: 1.1rem; background: #eaf2ff; padding: 16px; border-radius: 28px;" class="${currentTheme === 'dark' ? 'dark-bg-alt' : ''}">
                                ‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –≥–æ—Å—Ç—è ... <br>–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: ${usersCount}/2
                            </p>
                            ${usersCount === 2 ? `<button class="btn w-full" id="enterChatFromHostBtn" style="margin-top: 12px;">üí¨ –ü–µ—Ä–µ–π—Ç–∏ –≤ —á–∞—Ç</button>` : ''}
                            <p style="margin-top: 24px; color: #536878;">–ö–æ–º–Ω–∞—Ç–∞ –∞–∫—Ç–∏–≤–Ω–∞. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–¥ –≥–æ—Å—Ç—é.</p>
                        </div>
                    </div>
                `;
            }

            // ---- –ì–û–°–¢–¨: –≤–≤–æ–¥ –∫–æ–¥–∞ –∏ –∏–º–µ–Ω–∏ ----
            function renderGuestJoin() {
                return `
                    <div>
                        <button class="btn-outline" style="padding: 10px 22px; margin-bottom: 24px;" id="backToHomeBtn">‚Üê –í—Å–µ –∫–æ–º–Ω–∞—Ç—ã</button>
                        <div class="room-screen">
                            <h2>üîë –í–æ–π—Ç–∏ –≤ –∫–æ–º–Ω–∞—Ç—É</h2>
                            <input type="text" id="guestRoomCode" class="input-field" placeholder="–ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä ABC-123)" value="${appState.currentRoomCode || ''}">
                            <input type="text" id="guestName" class="input-field" placeholder="–í–∞—à–µ –∏–º—è" maxlength="20">
                            <button class="btn w-full" id="joinRoomSubmitBtn" style="margin-top: 16px;">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
                            <p id="joinErrorMsg" style="color: #e53e3e; margin-top: 12px;"></p>
                        </div>
                    </div>
                `;
            }

            // ---- –ß–ê–¢ –ö–û–ú–ù–ê–¢–´ (–æ–±—â–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —Ö–æ—Å—Ç–∞ –∏ –≥–æ—Å—Ç—è) ----
            function renderChatRoom() {
                const code = appState.currentRoomCode;
                const rooms = loadRooms();
                const room = rooms.find(r => r.code === code);
                if (!room) { appState.view = 'home'; return renderHome(); }
                const messages = getMessages(code);
                const currentUser = appState.currentUserName || '–ê–Ω–æ–Ω–∏–º';

                return `
                    <div>
                        <div style="display: flex; justify-content: space-between; align-items: baseline;">
                            <button class="btn-outline" style="padding: 8px 20px; margin-bottom: 20px;" id="backToHomeBtn">‚Üê –í—ã—Ö–æ–¥</button>
                            <span style="background: #3b82f620; padding: 8px 18px; border-radius: 40px; font-weight: 600;">${code}</span>
                        </div>
                        <div class="room-screen">
                            <h3 style="margin-bottom: 6px;">–ß–∞—Ç ‚Ä¢ ${room.hostName} –∏ –≥–æ—Å—Ç—å</h3>
                            <div class="chat-messages" id="chatMessagesContainer">
                                ${messages.map(msg => {
                                    const initials = msg.name.substring(0,2).toUpperCase();
                                    return `
                                    <div class="message">
                                        <div class="avatar" style="background: ${stringToColor(msg.name)};">${initials}</div>
                                        <div class="message-content">
                                            <span class="msg-author">${msg.name} <span class="msg-time">${msg.time}</span></span>
                                            <div class="msg-text">${escapeHTML(msg.text)}</div>
                                        </div>
                                    </div>`;
                                }).join('')}
                                ${messages.length === 0 ? '<p style="color: gray; text-align:center; padding: 30px;">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π ü§ç</p>' : ''}
                            </div>
                            <div style="display:flex; gap: 12px; margin-top: 16px;">
                                <input type="text" id="chatMessageInput" class="input-field" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off">
                                <button class="btn" id="sendMessageBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                            </div>
                        </div>
                    </div>
                `;
            }

            // —Ö–µ–ª–ø–µ—Ä —Ü–≤–µ—Ç –∞–≤–∞—Ç–∞—Ä–∞
            function stringToColor(str) {
                let hash = 0;
                for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
                const hue = Math.abs(hash % 360);
                return `hsl(${hue}, 70%, 60%)`;
            }

            function escapeHTML(text) {
                return String(text).replace(/[&<>"]/g, function(c) {
                    if(c === '&') return '&amp;';
                    if(c === '<') return '&lt;';
                    if(c === '>') return '&gt;';
                    if(c === '"') return '&quot;';
                    return c;
                });
            }

            // ---------- –ü–†–ò–ö–†–ï–ü–õ–ï–ù–ò–ï –°–û–ë–´–¢–ò–ô ----------
            function attachListeners() {
                // —Ç–µ–º–∞
                const themeBtn = document.getElementById('themeToggleBtn');
                if (themeBtn) themeBtn.onclick = toggleTheme;

                // –Ω–∞–∑–∞–¥ –Ω–∞ –≥–ª–∞–≤–Ω—É—é
                document.querySelectorAll('#backToHomeBtn').forEach(btn => {
                    btn.onclick = () => { appState = { view: 'home', currentRoomCode: null, currentUserName: null, currentUserIsHost: false }; render(); };
                });

                // —Å–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É
                const createBtn = document.getElementById('createRoomBtn');
                if (createBtn) {
                    createBtn.onclick = () => {
                        const hostName = prompt('–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è (—Ö–æ—Å—Ç):', '–•–æ—Å—Ç');
                        if (!hostName?.trim()) return;
                        const newCode = generateRoomCode();
                        const rooms = loadRooms();
                        const newRoom = { code: newCode, hostName: hostName.trim(), users: [] };
                        rooms.push(newRoom);
                        saveRooms(rooms);
                        appState = { view: 'hostRoom', currentRoomCode: newCode, currentUserName: hostName.trim(), currentUserIsHost: true };
                        render();
                    };
                }

                // –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞
                const copyBtn = document.getElementById('copyCodeBtn');
                if (copyBtn) {
                    copyBtn.onclick = () => {
                        const code = appState.currentRoomCode;
                        if (code) navigator.clipboard?.writeText(code).then(() => alert('–ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!'));
                    };
                }

                // —É–¥–∞–ª–µ–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã
                document.querySelectorAll('[data-action="deleteRoom"]').forEach(btn => {
                    btn.onclick = (e) => {
                        e.stopPropagation();
                        const code = btn.dataset.code;
                        if (code && confirm(`–£–¥–∞–ª–∏—Ç—å –∫–æ–º–Ω–∞—Ç—É ${code}?`)) deleteRoom(code);
                        render();
                    };
                });

                // –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫–∞–∫ –≥–æ—Å—Ç—å (—Å –≥–ª–∞–≤–Ω–æ–π)
                document.querySelectorAll('[data-action="joinAsGuest"]').forEach(btn => {
                    btn.onclick = () => {
                        const code = btn.dataset.code;
                        const rooms = loadRooms();
                        const room = rooms.find(r => r.code === code);
                        if (room && room.users.length >= 2) { alert('–ö–æ–º–Ω–∞—Ç–∞ –ø–æ–ª–Ω–∞—è (2/2)'); return; }
                        appState = { view: 'guestJoin', currentRoomCode: code, currentUserName: null, currentUserIsHost: false };
                        render();
                    };
                });

                // –≥–æ—Å—Ç—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ñ–æ—Ä–º—É
                const joinSubmit = document.getElementById('joinRoomSubmitBtn');
                if (joinSubmit) {
                    joinSubmit.onclick = () => {
                        const codeInput = document.getElementById('guestRoomCode')?.value.trim().toUpperCase();
                        const guestName = document.getElementById('guestName')?.value.trim();
                        const errorEl = document.getElementById('joinErrorMsg');
                        if (!codeInput || !guestName) { errorEl.textContent = '–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∏ –∏–º—è'; return; }
                        const rooms = loadRooms();
                        const room = rooms.find(r => r.code === codeInput);
                        if (!room) { errorEl.textContent = '–ö–æ–º–Ω–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞'; return; }
                        if (room.users.length >= 2) { errorEl.textContent = '–ö–æ–º–Ω–∞—Ç–∞ –ø–æ–ª–Ω–∞—è'; return; }
                        // –¥–æ–±–∞–≤–ª—è–µ–º –≥–æ—Å—Ç—è
                        const success = addUserToRoom(codeInput, guestName);
                        if (success) {
                            appState = { view: 'chatRoom', currentRoomCode: codeInput, currentUserName: guestName, currentUserIsHost: false };
                            // –¥–æ–±–∞–≤–∏—Ç—å —Å–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ ?
                            render();
                        } else { errorEl.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è'; }
                    };
                }

                // –∏–∑ hostRoom –≤ —á–∞—Ç –µ—Å–ª–∏ —É–∂–µ 2
                const enterChatBtn = document.getElementById('enterChatFromHostBtn');
                if (enterChatBtn) {
                    enterChatBtn.onclick = () => {
                        if (appState.currentRoomCode) {
                            appState.view = 'chatRoom';
                            appState.currentUserIsHost = true;
                            const rooms = loadRooms();
                            const room = rooms.find(r => r.code === appState.currentRoomCode);
                            if (room) appState.currentUserName = room.hostName;
                            render();
                        }
                    };
                }

                // –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
                const sendBtn = document.getElementById('sendMessageBtn');
                if (sendBtn) {
                    sendBtn.onclick = sendMessageHandler;
                }
                const msgInput = document.getElementById('chatMessageInput');
                if (msgInput) {
                    msgInput.onkeypress = (e) => { if (e.key === 'Enter') sendMessageHandler(e); };
                }

                // —Å–ª—É—à–∞—Ç–µ–ª—å storage –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —á–∞—Ç–∞ (polling —á–µ—Ä–µ–∑ —Å–æ–±—ã—Ç–∏—è storage)
                // —Ç–∞–∫–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º setInterval –¥–ª—è –∫—Ä–æ—Å—Å-—Ç–∞–±, –Ω–æ —Å–æ–±—ã—Ç–∏–µ storage —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Ä–∞–º–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞
            }

            function sendMessageHandler() {
                const input = document.getElementById('chatMessageInput');
                const text = input?.value.trim();
                if (!text || !appState.currentRoomCode || !appState.currentUserName) return;
                addMessage(appState.currentRoomCode, appState.currentUserName, text);
                input.value = '';
                // –µ—Å–ª–∏ –º—ã –≤ —á–∞—Ç–µ ‚Äî –ø–µ—Ä–µ—Ä–µ–Ω–¥–µ—Ä–∏—Ç—å, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
                if (appState.view === 'chatRoom') render();
                else { /* –Ω–∏—á–µ–≥–æ */ }
            }

            // ---------- –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø: —Å–ª—É—à–∞–µ–º localStorage (storage event) –∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–Ω–¥–µ—Ä —á–∞—Ç–∞ ----------
            window.addEventListener('storage', function(e) {
                // –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç —á–∞—Ç –∫–æ–º–Ω–∞—Ç—ã ‚Äî –æ–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
                if (appState.view === 'chatRoom' && appState.currentRoomCode) {
                    render(); // –æ–±–Ω–æ–≤–∏—Ç —Å–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π
                }
                // –µ—Å–ª–∏ –Ω–∞ –≥–ª–∞–≤–Ω–æ–π ‚Äî —Ç–æ–∂–µ –æ–±–Ω–æ–≤–∏–º –∫–æ–ª-–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
                if (appState.view === 'home' || appState.view === 'hostRoom') render();
            });

            // –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ: –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã –ø—Ä–æ–≤–µ—Ä—è—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (–¥–ª—è –æ—á–µ–Ω—å —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤)
            setInterval(() => {
                if (appState.view === 'chatRoom' && appState.currentRoomCode) {
                    // –º—è–≥–∫–∏–π —Ä–µ—Ä–µ–Ω–¥–µ—Ä —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å —Å–æ–æ–±—â–µ–Ω–∏—è ‚Äî –Ω–æ –º—ã –ø—Ä–æ—Å—Ç–æ rerender
                    render();
                }
            }, 2000);

            // ---------- –ó–ê–ü–£–°–ö ----------
            function init() {
                applyTheme(currentTheme);
                render();
            }
            init();
        })();
    </script>
</body>
</html>