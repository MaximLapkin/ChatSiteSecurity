<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LocalStorage Chat</title>
    <style>
        :root {
            --bg-color: #ffffff;
            --chat-bg: #f0f2f5;
            --sidebar-bg: #ffffff;
            --text-color: #050505;
            --input-bg: #f0f2f5;
            --primary-color: #0084ff;
            --received-msg-bg: #e4e6eb;
            --sent-msg-text: #ffffff;
            --border-color: #ddd;
        }

        [data-theme="dark"] {
            --bg-color: #18191a;
            --chat-bg: #242526;
            --sidebar-bg: #242526;
            --text-color: #e4e6eb;
            --input-bg: #3a3b3c;
            --primary-color: #2d88ff;
            --received-msg-bg: #3a3b3c;
            --sent-msg-text: #ffffff;
            --border-color: #3e4042;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        body { background-color: var(--bg-color); color: var(--text-color); height: 100vh; display: flex; transition: 0.3s; }

        /* –≠–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞ */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color); z-index: 100;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }

        .card {
            background: var(--sidebar-bg); padding: 2rem; border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); width: 90%; max-width: 400px;
            text-align: center; border: 1px solid var(--border-color);
        }

        input {
            width: 100%; padding: 12px; margin: 10px 0; border-radius: 5px;
            border: 1px solid var(--border-color); background: var(--input-bg);
            color: var(--text-color); outline: none;
        }

        button {
            width: 100%; padding: 12px; border: none; border-radius: 5px;
            background: var(--primary-color); color: white; font-weight: bold;
            cursor: pointer; margin-top: 5px; transition: 0.2s;
        }
        button:hover { opacity: 0.9; }
        button.secondary { background: transparent; border: 1px solid var(--primary-color); color: var(--primary-color); }

        /* –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —á–∞—Ç–∞ */
        #chat-app { display: none; width: 100%; height: 100%; flex-direction: column; }

        header {
            padding: 15px; background: var(--sidebar-bg); border-bottom: 1px solid var(--border-color);
            display: flex; justify-content: space-between; align-items: center;
        }
        
        .room-info { font-size: 0.9rem; }
        .room-code { font-weight: bold; color: var(--primary-color); cursor: pointer; }

        #messages-area {
            flex: 1; overflow-y: auto; padding: 20px; background: var(--chat-bg);
            display: flex; flex-direction: column; gap: 10px;
        }

        .message {
            max-width: 70%; padding: 10px 15px; border-radius: 18px; font-size: 0.95rem;
            position: relative; line-height: 1.4; word-wrap: break-word;
        }

        .message.sent {
            align-self: flex-end; background: var(--primary-color); color: var(--sent-msg-text);
            border-bottom-right-radius: 2px;
        }

        .message.received {
            align-self: flex-start; background: var(--received-msg-bg); color: var(--text-color);
            border-bottom-left-radius: 2px;
        }

        .meta { font-size: 0.7rem; opacity: 0.7; margin-bottom: 2px; display: block; }

        footer {
            padding: 15px; background: var(--sidebar-bg); border-top: 1px solid var(--border-color);
            display: flex; gap: 10px;
        }

        /* –£—Ç–∏–ª–∏—Ç—ã */
        .theme-toggle { background: none; border: none; font-size: 1.5rem; width: auto; color: var(--text-color); }
        .hidden { display: none !important; }
        
        /* –°–∫—Ä–æ–ª–ª–±–∞—Ä */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }
        ::-webkit-scrollbar-track { background: transparent; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="card">
            <h2>Local Chat</h2>
            <p style="margin-bottom: 20px; opacity: 0.7; font-size: 0.9rem;">–†–∞–±–æ—Ç–∞–µ—Ç –º–µ–∂–¥—É –≤–∫–ª–∞–¥–∫–∞–º–∏ –±—Ä–∞—É–∑–µ—Ä–∞</p>
            
            <input type="text" id="username-input" placeholder="–í–∞—à–µ –∏–º—è" maxlength="15">
            
            <div style="margin: 20px 0; border-top: 1px solid var(--border-color); position: relative;">
                <span style="position: absolute; top: -10px; left: 50%; transform: translateX(-50%); background: var(--sidebar-bg); padding: 0 10px; font-size: 0.8rem; opacity: 0.7;">–ò–õ–ò</span>
            </div>

            <button onclick="createRoom()">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∫–æ–º–Ω–∞—Ç—É</button>
            <input type="text" id="room-code-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∫–æ–º–Ω–∞—Ç—ã">
            <button class="secondary" onclick="joinRoom()">–í–æ–π—Ç–∏ –≤ –∫–æ–º–Ω–∞—Ç—É</button>
            
            <div style="margin-top: 20px;">
                <button class="theme-toggle" onclick="toggleTheme()">üåì</button>
            </div>
        </div>
    </div>

    <div id="chat-app">
        <header>
            <div class="room-info">
                –ö–æ–º–Ω–∞—Ç–∞: <span id="display-room-code" class="room-code" onclick="copyCode()" title="–ù–∞–∂–º–∏ —á—Ç–æ–±—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å">---</span>
                <br><span style="font-size: 0.8em; opacity: 0.7;">–í—ã: <span id="display-username"></span></span>
            </div>
            <div>
                <button class="secondary" style="width: auto; padding: 5px 15px;" onclick="leaveRoom()">–í—ã–π—Ç–∏</button>
                <button class="theme-toggle" onclick="toggleTheme()">üåì</button>
            </div>
        </header>

        <div id="messages-area"></div>

        <footer>
            <input type="text" id="message-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." onkeypress="handleEnter(event)">
            <button style="width: auto; padding: 0 20px;" onclick="sendMessage()">‚û§</button>
        </footer>
    </div>

    <script>
        // --- –õ–æ–≥–∏–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ---
        
        let currentUser = '';
        let currentRoom = '';
        
        // –ö–ª—é—á –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ LocalStorage
        const STORAGE_PREFIX = 'local_chat_room_';

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–º—ã
        if (localStorage.getItem('theme') === 'dark') {
            document.body.setAttribute('data-theme', 'dark');
        }

        // 1. –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã
        function createRoom() {
            const user = document.getElementById('username-input').value.trim();
            if (!user) return alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è!');

            const roomId = Math.random().toString(36).substr(2, 6).toUpperCase();
            enterChat(user, roomId);
        }

        // 2. –í—Ö–æ–¥ –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∫–æ–º–Ω–∞—Ç—É
        function joinRoom() {
            const user = document.getElementById('username-input').value.trim();
            const roomId = document.getElementById('room-code-input').value.trim().toUpperCase();

            if (!user) return alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è!');
            if (!roomId) return alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∫–æ–º–Ω–∞—Ç—ã!');

            enterChat(user, roomId);
        }

        // –õ–æ–≥–∏–∫–∞ –≤—Ö–æ–¥–∞
        function enterChat(user, roomId) {
            currentUser = user;
            currentRoom = roomId;

            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('chat-app').style.display = 'flex';
            
            document.getElementById('display-username').textContent = currentUser;
            document.getElementById('display-room-code').textContent = currentRoom;

            loadMessages();
            scrollToBottom();
        }

        // 3. –í—ã—Ö–æ–¥
        function leaveRoom() {
            currentUser = '';
            currentRoom = '';
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('chat-app').style.display = 'none';
        }

        // 4. –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        function sendMessage() {
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            if (!text) return;

            const message = {
                id: Date.now(),
                user: currentUser,
                text: text,
                time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
            };

            saveMessage(message);
            input.value = '';
            loadMessages(); // –û–±–Ω–æ–≤–ª—è–µ–º —É —Å–µ–±—è
        }

        function handleEnter(e) {
            if (e.key === 'Enter') sendMessage();
        }

        // 5. –†–∞–±–æ—Ç–∞ —Å LocalStorage
        function saveMessage(msg) {
            const key = STORAGE_PREFIX + currentRoom;
            let history = JSON.parse(localStorage.getItem(key) || '[]');
            history.push(msg);
            localStorage.setItem(key, JSON.stringify(history));
        }

        function loadMessages() {
            if (!currentRoom) return;

            const key = STORAGE_PREFIX + currentRoom;
            const history = JSON.parse(localStorage.getItem(key) || '[]');
            const container = document.getElementById('messages-area');
            
            container.innerHTML = ''; // –û—á–∏—Å—Ç–∫–∞ (–Ω–µ –∏–¥–µ–∞–ª—å–Ω–æ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏, –Ω–æ –ø—Ä–æ—Å—Ç–æ –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞)

            history.forEach(msg => {
                const div = document.createElement('div');
                const isMine = msg.user === currentUser;
                
                div.className = `message ${isMine ? 'sent' : 'received'}`;
                div.innerHTML = `
                    <span class="meta">${isMine ? '–í—ã' : msg.user} ‚Ä¢ ${msg.time}</span>
                    ${escapeHtml(msg.text)}
                `;
                container.appendChild(div);
            });
            
            scrollToBottom();
        }

        // 6. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –º–µ–∂–¥—É –≤–∫–ª–∞–¥–∫–∞–º–∏
        // –≠—Ç–æ "–º–∞–≥–∏—è", –∫–æ—Ç–æ—Ä–∞—è –∑–∞—Å—Ç–∞–≤–ª—è–µ—Ç —á–∞—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
        window.addEventListener('storage', (e) => {
            if (e.key === STORAGE_PREFIX + currentRoom) {
                loadMessages();
            }
        });

        // –£—Ç–∏–ª–∏—Ç—ã
        function scrollToBottom() {
            const area = document.getElementById('messages-area');
            area.scrollTop = area.scrollHeight;
        }

        function toggleTheme() {
            const body = document.body;
            if (body.getAttribute('data-theme') === 'dark') {
                body.removeAttribute('data-theme');
                localStorage.setItem('theme', 'light');
            } else {
                body.setAttribute('data-theme', 'dark');
                localStorage.setItem('theme', 'dark');
            }
        }

        function copyCode() {
            navigator.clipboard.writeText(currentRoom).then(() => {
                alert('–ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω: ' + currentRoom);
            });
        }

        function escapeHtml(text) {
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
    </script>
</body>
</html>
